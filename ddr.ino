/*
  ika DDR pad test
*/

// Lib
// ===

#include <USBComposite.h>
#include "HX711.h"
#include "FIRFilter.h"
// #include "RunningAverage.h"


// Constants
// ===

#define SENSOR_COUNT 4
// Average analog readings over this many readings, to smooth it out.
// #define SMOOTH_CYCLES 10

// Analog Input pins receiving the HX711 readings. 1 per step.
const byte sensorInPins[SENSOR_COUNT] = {4, 5, 6, 7};

// PVM Output pins for communicating with HX711.
const byte sensorOutPins[SENSOR_COUNT] = {8, 9, 10, 11};

// Keycodes to emit when respective sensors are pressed
// Right: 215, Left: 216, Down: 217, Up: 218
const byte sensorKeycodes[SENSOR_COUNT] = {215, 216, 217, 218}; // R L D U

// Calibration factor for sensor to measure accurately 1 kg.
const float sensorCalibrations[SENSOR_COUNT] = {-22000, -22000, -22000, -22000};

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 80 Hz

* 0 Hz - 4 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 4.167215398444177 dB

* 4.1 Hz - 40 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.017520884083524 dB

*/

#define FILTER_TAP_NUM 785

const float filterTaps[FILTER_TAP_NUM] = {
  0.004943922432501054,
  -0.00022929579267258484,
  -0.0005924975435981516,
  -0.0011880717227510532,
  -0.0019985935472825777,
  -0.0029967027076279293,
  -0.0041432368838089095,
  -0.005387776541892666,
  -0.006669845876422557,
  -0.007921762305324417,
  -0.009072127594213743,
  -0.010050222998864442,
  -0.01079061146446652,
  -0.011237903422631241,
  -0.01135102905783898,
  -0.011106831352240805,
  -0.01050248789716338,
  -0.009556669488355846,
  -0.008309160306320467,
  -0.00681898504895757,
  -0.005161017060807375,
  -0.0034213498410727416,
  -0.001691691592005548,
  -0.00006325144662951883,
  0.0013794814775948622,
  0.00256455250970707,
  0.003437530914986928,
  0.003965235566592548,
  0.00413791948419135,
  0.003969713487789882,
  0.003497313973048481,
  0.0027769951891177904,
  0.0018801808935626197,
  0.0008879008462622324,
  -0.00011543297139004925,
  -0.0010484489292760936,
  -0.0018389355381405919,
  -0.0024291749775505176,
  -0.0027800676190810427,
  -0.002873698205836464,
  -0.002714142465923811,
  -0.0023264409106346067,
  -0.0017538648160037962,
  -0.0010537065407327571,
  -0.00029200372238567617,
  0.00046235622918868493,
  0.0011435834358227458,
  0.001694506609006076,
  0.00207117026679234,
  0.0022462267963140542,
  0.002210834959546098,
  0.001975018600096496,
  0.0015663800055414757,
  0.0010273609476543948,
  0.00041114920478906275,
  -0.00022330745499831052,
  -0.0008169131576334808,
  -0.0013159387496618365,
  -0.0016770603477299988,
  -0.0018710192125252747,
  -0.0018848373217758335,
  -0.0017220138960301159,
  -0.0014016531818762563,
  -0.0009560293454270295,
  -0.00042863291448574925,
  0.00013054938806323474,
  0.0006487654447056738,
  0.001107715173162107,
  0.0014461642277249316,
  0.0016391152409905437,
  0.0016711352273625596,
  0.001542312330566886,
  0.0012678197368874388,
  0.0008765509951298632,
  0.00040794149287807564,
  -0.00009175875264329143,
  -0.0005740568772316733,
  -0.0009927802885973517,
  -0.0013085406895523718,
  -0.0014923676199228234,
  -0.0015283916619065101,
  -0.0014151618443825375,
  -0.0011656556172612213,
  -0.0008058512877428057,
  -0.0003721070271795779,
  0.0000924928993279135,
  0.0005423643507689151,
  0.0009338676267338549,
  0.0012294784554420443,
  0.0014013581413383882,
  0.0014339476891659232,
  0.001325384181355748,
  0.0010875672332598518,
  0.000744907389780078,
  0.000331861801306594,
  -0.00011047564344241956,
  -0.0005384218178546094,
  -0.0009099875498591849,
  -0.001188989628876733,
  -0.0013485731150908338,
  -0.0013737967079739096,
  -0.0012630275989437016,
  -0.001028016305777243,
  -0.0006926605056416945,
  -0.00029058341114061224,
  0.00013821095303094297,
  0.0005512835615785393,
  0.0009079058405792202,
  0.0011730403342377891,
  0.0013207607972874785,
  0.0013368134474437277,
  0.0012200153998082064,
  0.00098237135347328,
  0.0006478354593766718,
  0.00024990170722552545,
  -0.0001717856006605963,
  -0.000575370163816741,
  -0.000920943441850964,
  -0.0011744044017888194,
  -0.0013107709366545932,
  -0.001316542339897499,
  -0.0011911052692706017,
  -0.0009468657497908923,
  -0.0006082309997497924,
  -0.00020911970076391593,
  0.00021046671421998605,
  0.0006088217608962294,
  0.0009465722844858011,
  0.0011906659465585308,
  0.0013165215511595613,
  0.0013109204478624732,
  0.0011717061832759233,
  0.000919785263491039,
  0.0005729797095257379,
  0.0001690663069703463,
  -0.00025249666386547426,
  -0.000649652482537569,
  -0.0009828059452154335,
  -0.0012185147912114054,
  -0.0013330883580093026,
  -0.0013147649467917385,
  -0.0011650317516270568,
  -0.0008984449978111324,
  -0.0005413157048724512,
  -0.00012905227424686398,
  0.0002973123251811549,
  0.0006952400815207995,
  0.0010248690007198,
  0.0012530072897775383,
  0.0013564397534138613,
  0.0013243171906126261,
  0.001159277860028666,
  0.0008772556237811378,
  0.0005059286822301893,
  0.0000820286880849999,
  -0.00035228284539431725,
  -0.0007535825307688732,
  -0.001081531487321355,
  -0.0013029250194580015,
  -0.0013950555554047535,
  -0.001348020813063204,
  -0.0011657708384935246,
  -0.0008657776965292813,
  -0.00047737103464738813,
  -0.00003888596045997418,
  0.0004060979817907524,
  0.0008130653427124627,
  0.0011410023913811698,
  0.0013565246400948643,
  0.001437285972483492,
  0.0013743008169897878,
  0.0011729392858792005,
  0.0008524650244069263,
  0.0004441860211097206,
  -0.000011615009072624343,
  -0.00046963200098805365,
  -0.0008840196216671686,
  -0.0012129355638138188,
  -0.0014227491716090161,
  -0.0014914514924571497,
  -0.0014109897057482223,
  -0.001188200461926051,
  -0.0008442896240567751,
  -0.00041277314780806046,
  0.00006380715033211866,
  0.0005381496820278011,
  0.0009628113513141286,
  0.0012949084265614468,
  0.0015002980717789686,
  0.0015571826832679768,
  0.0014584332082623358,
  0.001212689039973131,
  0.0008433879979826776,
  0.00038658639919777636,
  -0.00011325676216196798,
  -0.0006066042363006901,
  -0.0010443473593921629,
  -0.0013797396508223485,
  -0.0015817600788494653,
  -0.001626384602237519,
  -0.0015086462425097393,
  -0.0012385346119610195,
  -0.0008416762799560759,
  -0.00035652749392169134,
  0.00016912413238643904,
  0.0006830850502147482,
  0.0011337699270770054,
  0.0014754310426803986,
  0.001672699116554477,
  0.0017043187787812682,
  0.0015653865833194901,
  0.0012680523318112332,
  0.0008404257902747317,
  0.00032396229708235965,
  -0.00023055603558638842,
  -0.0007679642152651901,
  -0.0012342148336355872,
  -0.0015817989828797248,
  -0.0017745963012449273,
  -0.001791588453728665,
  -0.0016291210500741905,
  -0.0013014433416613466,
  -0.0008395017321446421,
  -0.0002880409841814154,
  0.000298698395643331,
  0.0008623036844348379,
  0.0013459876830776718,
  0.0017003011730852848,
  0.0018881725002642485,
  0.0018887715192921941,
  0.001699786080177902,
  0.0013378673897279658,
  0.0008371838343592353,
  0.0002462121295384752,
  -0.00037692545936145086,
  -0.0009701468730048576,
  -0.0014735614321256176,
  -0.0018354999782893933,
  -0.0020177958284361033,
  -0.001999798297790181,
  -0.001780665958236267,
  -0.0013797185336120099,
  -0.0008347445924553404,
  -0.00019846069604870177,
  0.00046658589851898805,
  0.0010941085149746988,
  0.0016206517884513737,
  0.0019919428191326432,
  0.002168502425148442,
  0.002129820182014147,
  0.0018767311199259962,
  0.0014315506523896503,
  0.0008361302539723673,
  0.00014786609334603622,
  -0.0005656722975111824,
  -0.0012333498211400675,
  -0.0017873819262625048,
  -0.0021704563493692513,
  -0.002341535839795972,
  -0.0022806085177889818,
  -0.001989931372269515,
  -0.0014952179145055176,
  -0.0008419632841580142,
  -0.0000949889440563969,
  0.0006741191798135831,
  0.0013875734784154303,
  0.001973403322089297,
  0.002370713608852371,
  0.002536638175225621,
  0.0024506902436140124,
  0.0021174075400551312,
  0.0015661025467625504,
  0.0008484315920024729,
  0.000033531241784833624,
  -0.000798496796171209,
  -0.0015644715017096003,
  -0.0021863808245293063,
  -0.0025993374611801515,
  -0.0027582519065492495,
  -0.0026426929638722315,
  -0.0022593315646331907,
  -0.0016417976359170228,
  -0.0008478084569198775,
  0.000046141161430884743,
  0.0009521137475780509,
  0.001779318497764206,
  0.002443158082204479,
  0.002873795078366753,
  0.003023424628601983,
  0.002871475778140125,
  0.0024272087600889537,
  0.0017293708594402503,
  0.0008429099411232032,
  -0.00014699632212523142,
  -0.0011430423539663687,
  -0.002045277843291813,
  -0.0027610538877059854,
  -0.0032144492583262995,
  -0.003354222752490439,
  -0.0031594617134583784,
  -0.002642327395984734,
  -0.0018475533235820752,
  -0.0008486939896896835,
  0.00025859270150913386,
  0.0013656006781956414,
  0.0023611502206101523,
  0.003142636929026652,
  0.003626510750289509,
  0.003757077502276545,
  0.0035127438771651006,
  0.0029089577672084203,
  0.001997558471316876,
  0.0008624668337955694,
  -0.0003878451608828819,
  -0.0016305701868962296,
  -0.002740439813957409,
  -0.003602267562765229,
  -0.00412271618658855,
  -0.004240246227356798,
  -0.003931973763065063,
  -0.0032170499458399502,
  -0.002155828357152132,
  -0.0008452503849266179,
  0.0005899755897933707,
  0.0020088082563065285,
  0.003268310716921792,
  0.004236477475899018,
  0.004807383641714573,
  0.004909998785059376,
  0.004520291401879467,
  0.0036606549517506507,
  0.002402759007679766,
  0.0008597493488565236,
  -0.0008226147900760738,
  -0.0024797328556764543,
  -0.0039437278547793065,
  -0.0050602892210232795,
  -0.0057043626867202156,
  -0.005793677713009012,
  -0.005298368894306007,
  -0.00424596560782883,
  -0.002720799268280967,
  -0.0008578546677294052,
  0.0011687206956377703,
  0.003161335732058616,
  0.004917625422337024,
  0.006250256704218,
  0.007006111065075673,
  0.007082887852667836,
  0.006441475769552219,
  0.005112637839475586,
  0.003197177086553547,
  0.0008592558582877336,
  -0.0016867269751178826,
  -0.004194757269662571,
  -0.006409762419559013,
  -0.008092156117942026,
  -0.009042097275487774,
  -0.009121156881030719,
  -0.00826920363600935,
  -0.006514697355907615,
  -0.00397709336968336,
  -0.0008607396271044269,
  0.002559597861404871,
  0.005960674691558342,
  0.008998534172483443,
  0.011339881601132572,
  0.012694398672477812,
  0.012845158736060914,
  0.01167430565035612,
  0.009181511166405745,
  0.0054931979807342724,
  0.0008612999731767992,
  -0.004348909587345717,
  -0.00968138054325253,
  -0.014620880766163313,
  -0.0186312999989552,
  -0.02119782859237718,
  -0.021869616276772506,
  -0.0202995764392896,
  -0.016277902155214904,
  -0.009756480057273538,
  -0.0008617216337033928,
  0.01010542109530684,
  0.0226828452479939,
  0.03627308374987613,
  0.050180149115195756,
  0.06365447473276027,
  0.07594335883869958,
  0.08634232215710681,
  0.09424460241354915,
  0.09918243677291445,
  0.10086219204810287,
  0.09918243677291445,
  0.09424460241354915,
  0.08634232215710681,
  0.07594335883869958,
  0.06365447473276027,
  0.050180149115195756,
  0.03627308374987613,
  0.0226828452479939,
  0.01010542109530684,
  -0.0008617216337033928,
  -0.009756480057273538,
  -0.016277902155214904,
  -0.0202995764392896,
  -0.021869616276772506,
  -0.02119782859237718,
  -0.0186312999989552,
  -0.014620880766163313,
  -0.00968138054325253,
  -0.004348909587345717,
  0.0008612999731767992,
  0.0054931979807342724,
  0.009181511166405745,
  0.01167430565035612,
  0.012845158736060914,
  0.012694398672477812,
  0.011339881601132572,
  0.008998534172483443,
  0.005960674691558342,
  0.002559597861404871,
  -0.0008607396271044269,
  -0.00397709336968336,
  -0.006514697355907615,
  -0.00826920363600935,
  -0.009121156881030719,
  -0.009042097275487774,
  -0.008092156117942026,
  -0.006409762419559013,
  -0.004194757269662571,
  -0.0016867269751178826,
  0.0008592558582877336,
  0.003197177086553547,
  0.005112637839475586,
  0.006441475769552219,
  0.007082887852667836,
  0.007006111065075673,
  0.006250256704218,
  0.004917625422337024,
  0.003161335732058616,
  0.0011687206956377703,
  -0.0008578546677294052,
  -0.002720799268280967,
  -0.00424596560782883,
  -0.005298368894306007,
  -0.005793677713009012,
  -0.0057043626867202156,
  -0.0050602892210232795,
  -0.0039437278547793065,
  -0.0024797328556764543,
  -0.0008226147900760738,
  0.0008597493488565236,
  0.002402759007679766,
  0.0036606549517506507,
  0.004520291401879467,
  0.004909998785059376,
  0.004807383641714573,
  0.004236477475899018,
  0.003268310716921792,
  0.0020088082563065285,
  0.0005899755897933707,
  -0.0008452503849266179,
  -0.002155828357152132,
  -0.0032170499458399502,
  -0.003931973763065063,
  -0.004240246227356798,
  -0.00412271618658855,
  -0.003602267562765229,
  -0.002740439813957409,
  -0.0016305701868962296,
  -0.0003878451608828819,
  0.0008624668337955694,
  0.001997558471316876,
  0.0029089577672084203,
  0.0035127438771651006,
  0.003757077502276545,
  0.003626510750289509,
  0.003142636929026652,
  0.0023611502206101523,
  0.0013656006781956414,
  0.00025859270150913386,
  -0.0008486939896896835,
  -0.0018475533235820752,
  -0.002642327395984734,
  -0.0031594617134583784,
  -0.003354222752490439,
  -0.0032144492583262995,
  -0.0027610538877059854,
  -0.002045277843291813,
  -0.0011430423539663687,
  -0.00014699632212523142,
  0.0008429099411232032,
  0.0017293708594402503,
  0.0024272087600889537,
  0.002871475778140125,
  0.003023424628601983,
  0.002873795078366753,
  0.002443158082204479,
  0.001779318497764206,
  0.0009521137475780509,
  0.000046141161430884743,
  -0.0008478084569198775,
  -0.0016417976359170228,
  -0.0022593315646331907,
  -0.0026426929638722315,
  -0.0027582519065492495,
  -0.0025993374611801515,
  -0.0021863808245293063,
  -0.0015644715017096003,
  -0.000798496796171209,
  0.000033531241784833624,
  0.0008484315920024729,
  0.0015661025467625504,
  0.0021174075400551312,
  0.0024506902436140124,
  0.002536638175225621,
  0.002370713608852371,
  0.001973403322089297,
  0.0013875734784154303,
  0.0006741191798135831,
  -0.0000949889440563969,
  -0.0008419632841580142,
  -0.0014952179145055176,
  -0.001989931372269515,
  -0.0022806085177889818,
  -0.002341535839795972,
  -0.0021704563493692513,
  -0.0017873819262625048,
  -0.0012333498211400675,
  -0.0005656722975111824,
  0.00014786609334603622,
  0.0008361302539723673,
  0.0014315506523896503,
  0.0018767311199259962,
  0.002129820182014147,
  0.002168502425148442,
  0.0019919428191326432,
  0.0016206517884513737,
  0.0010941085149746988,
  0.00046658589851898805,
  -0.00019846069604870177,
  -0.0008347445924553404,
  -0.0013797185336120099,
  -0.001780665958236267,
  -0.001999798297790181,
  -0.0020177958284361033,
  -0.0018354999782893933,
  -0.0014735614321256176,
  -0.0009701468730048576,
  -0.00037692545936145086,
  0.0002462121295384752,
  0.0008371838343592353,
  0.0013378673897279658,
  0.001699786080177902,
  0.0018887715192921941,
  0.0018881725002642485,
  0.0017003011730852848,
  0.0013459876830776718,
  0.0008623036844348379,
  0.000298698395643331,
  -0.0002880409841814154,
  -0.0008395017321446421,
  -0.0013014433416613466,
  -0.0016291210500741905,
  -0.001791588453728665,
  -0.0017745963012449273,
  -0.0015817989828797248,
  -0.0012342148336355872,
  -0.0007679642152651901,
  -0.00023055603558638842,
  0.00032396229708235965,
  0.0008404257902747317,
  0.0012680523318112332,
  0.0015653865833194901,
  0.0017043187787812682,
  0.001672699116554477,
  0.0014754310426803986,
  0.0011337699270770054,
  0.0006830850502147482,
  0.00016912413238643904,
  -0.00035652749392169134,
  -0.0008416762799560759,
  -0.0012385346119610195,
  -0.0015086462425097393,
  -0.001626384602237519,
  -0.0015817600788494653,
  -0.0013797396508223485,
  -0.0010443473593921629,
  -0.0006066042363006901,
  -0.00011325676216196798,
  0.00038658639919777636,
  0.0008433879979826776,
  0.001212689039973131,
  0.0014584332082623358,
  0.0015571826832679768,
  0.0015002980717789686,
  0.0012949084265614468,
  0.0009628113513141286,
  0.0005381496820278011,
  0.00006380715033211866,
  -0.00041277314780806046,
  -0.0008442896240567751,
  -0.001188200461926051,
  -0.0014109897057482223,
  -0.0014914514924571497,
  -0.0014227491716090161,
  -0.0012129355638138188,
  -0.0008840196216671686,
  -0.00046963200098805365,
  -0.000011615009072624343,
  0.0004441860211097206,
  0.0008524650244069263,
  0.0011729392858792005,
  0.0013743008169897878,
  0.001437285972483492,
  0.0013565246400948643,
  0.0011410023913811698,
  0.0008130653427124627,
  0.0004060979817907524,
  -0.00003888596045997418,
  -0.00047737103464738813,
  -0.0008657776965292813,
  -0.0011657708384935246,
  -0.001348020813063204,
  -0.0013950555554047535,
  -0.0013029250194580015,
  -0.001081531487321355,
  -0.0007535825307688732,
  -0.00035228284539431725,
  0.0000820286880849999,
  0.0005059286822301893,
  0.0008772556237811378,
  0.001159277860028666,
  0.0013243171906126261,
  0.0013564397534138613,
  0.0012530072897775383,
  0.0010248690007198,
  0.0006952400815207995,
  0.0002973123251811549,
  -0.00012905227424686398,
  -0.0005413157048724512,
  -0.0008984449978111324,
  -0.0011650317516270568,
  -0.0013147649467917385,
  -0.0013330883580093026,
  -0.0012185147912114054,
  -0.0009828059452154335,
  -0.000649652482537569,
  -0.00025249666386547426,
  0.0001690663069703463,
  0.0005729797095257379,
  0.000919785263491039,
  0.0011717061832759233,
  0.0013109204478624732,
  0.0013165215511595613,
  0.0011906659465585308,
  0.0009465722844858011,
  0.0006088217608962294,
  0.00021046671421998605,
  -0.00020911970076391593,
  -0.0006082309997497924,
  -0.0009468657497908923,
  -0.0011911052692706017,
  -0.001316542339897499,
  -0.0013107709366545932,
  -0.0011744044017888194,
  -0.000920943441850964,
  -0.000575370163816741,
  -0.0001717856006605963,
  0.00024990170722552545,
  0.0006478354593766718,
  0.00098237135347328,
  0.0012200153998082064,
  0.0013368134474437277,
  0.0013207607972874785,
  0.0011730403342377891,
  0.0009079058405792202,
  0.0005512835615785393,
  0.00013821095303094297,
  -0.00029058341114061224,
  -0.0006926605056416945,
  -0.001028016305777243,
  -0.0012630275989437016,
  -0.0013737967079739096,
  -0.0013485731150908338,
  -0.001188989628876733,
  -0.0009099875498591849,
  -0.0005384218178546094,
  -0.00011047564344241956,
  0.000331861801306594,
  0.000744907389780078,
  0.0010875672332598518,
  0.001325384181355748,
  0.0014339476891659232,
  0.0014013581413383882,
  0.0012294784554420443,
  0.0009338676267338549,
  0.0005423643507689151,
  0.0000924928993279135,
  -0.0003721070271795779,
  -0.0008058512877428057,
  -0.0011656556172612213,
  -0.0014151618443825375,
  -0.0015283916619065101,
  -0.0014923676199228234,
  -0.0013085406895523718,
  -0.0009927802885973517,
  -0.0005740568772316733,
  -0.00009175875264329143,
  0.00040794149287807564,
  0.0008765509951298632,
  0.0012678197368874388,
  0.001542312330566886,
  0.0016711352273625596,
  0.0016391152409905437,
  0.0014461642277249316,
  0.001107715173162107,
  0.0006487654447056738,
  0.00013054938806323474,
  -0.00042863291448574925,
  -0.0009560293454270295,
  -0.0014016531818762563,
  -0.0017220138960301159,
  -0.0018848373217758335,
  -0.0018710192125252747,
  -0.0016770603477299988,
  -0.0013159387496618365,
  -0.0008169131576334808,
  -0.00022330745499831052,
  0.00041114920478906275,
  0.0010273609476543948,
  0.0015663800055414757,
  0.001975018600096496,
  0.002210834959546098,
  0.0022462267963140542,
  0.00207117026679234,
  0.001694506609006076,
  0.0011435834358227458,
  0.00046235622918868493,
  -0.00029200372238567617,
  -0.0010537065407327571,
  -0.0017538648160037962,
  -0.0023264409106346067,
  -0.002714142465923811,
  -0.002873698205836464,
  -0.0027800676190810427,
  -0.0024291749775505176,
  -0.0018389355381405919,
  -0.0010484489292760936,
  -0.00011543297139004925,
  0.0008879008462622324,
  0.0018801808935626197,
  0.0027769951891177904,
  0.003497313973048481,
  0.003969713487789882,
  0.00413791948419135,
  0.003965235566592548,
  0.003437530914986928,
  0.00256455250970707,
  0.0013794814775948622,
  -0.00006325144662951883,
  -0.001691691592005548,
  -0.0034213498410727416,
  -0.005161017060807375,
  -0.00681898504895757,
  -0.008309160306320467,
  -0.009556669488355846,
  -0.01050248789716338,
  -0.011106831352240805,
  -0.01135102905783898,
  -0.011237903422631241,
  -0.01079061146446652,
  -0.010050222998864442,
  -0.009072127594213743,
  -0.007921762305324417,
  -0.006669845876422557,
  -0.005387776541892666,
  -0.0041432368838089095,
  -0.0029967027076279293,
  -0.0019985935472825777,
  -0.0011880717227510532,
  -0.0005924975435981516,
  -0.00022929579267258484,
  0.004943922432501054
};


// Variables
// ===

// Threshold after which KeyDown event is sent.
// TODO: Runtime calibration
// with Filter
// float sensorThresholds[SENSOR_COUNT] = {0.25, 0.25, 0.25, 0.25};

// Vanilla
float sensorThresholds[SENSOR_COUNT] = {3.0, 3.0, 3.0, 3.0};

float sensorReadings[SENSOR_COUNT];

HX711 *sensors [SENSOR_COUNT];

FIRFilter *filters [SENSOR_COUNT];

// Smooth over several readings to compensate for noise.
//RunningAverage *smoothReadings [SENSOR_COUNT];

// Store if sensors were down the last reading cycle,
// to allow us to send key Press and Release events.
bool sensorLastDown[SENSOR_COUNT];


void setup() {
  // Delay because I dunno
  delay(1000);
  
  // Ignored by Maple. But needed by boards using Hardware serial via a USB to Serial Adaptor
  Serial.begin(115200);
  USBHID_begin_with_serial(HID_KEYBOARD);
  Keyboard.begin(); // useful to detect host capslock state and LEDs

  for (byte n = 0; n < SENSOR_COUNT; n++) {
    CompositeSerial.print("setup() sensor ");
    CompositeSerial.print(n);
    CompositeSerial.print("; ");
    
    //pinMode(sensorInPins[n], INPUT_ANALOG);
    sensorReadings[n] = 0;
    sensorLastDown[n] = false;
    sensors[n] = new HX711(sensorInPins[n], sensorOutPins[n], 128);
    
    sensors[n]->set_scale();
    sensors[n]->tare(); // Reset scale to 0

    long zero_factor = sensors[n]->read_average(); // Get baseline reading
    CompositeSerial.print("Zero factor: "); // This can be used to remove the need to tare the scale. Useful in permanent scale projects.
    CompositeSerial.println(zero_factor);
    
    sensors[n]->set_scale(sensorCalibrations[n]);

    filters[n] = new FIRFilter(filterTaps);
  
    // TODO: Runtime calibration
    // sensorThresholds[n] = 220;
    // smoothReadings[n] = new RunningAverage(SMOOTH_CYCLES);
  }

  // Delay because I dunno
  delay(1000);
}

void loop() {
  for (byte n = 0; n < SENSOR_COUNT; n++) {
    loopSensor(n);
  }

  // Formatting
  CompositeSerial.print("\n");
}

void loopSensor(int sensorId) {
//  int sensorValue = analogRead( sensorInPins[sensorId] );
  float rawValue = sensors[sensorId]->get_units();
//  float filterValue = filters[sensorId]->filter(rawValue);
//  float resultValue = abs(filterValue);

    CompositeSerial.print("S");
    CompositeSerial.print(sensorId);
    CompositeSerial.print(": ");
    CompositeSerial.print(rawValue);
//    CompositeSerial.print(" -> ");
//    CompositeSerial.print(filterValue);
    CompositeSerial.print("; ");

//  smoothReadings[sensorId]->addValue(sensorValue);
//  int smoothAverage = int(smoothReadings[sensorId]->getAverage());

  if (rawValue > sensorThresholds[sensorId]) {
    if (sensorLastDown[sensorId] != true) {
      Keyboard.press(sensorKeycodes[sensorId]);
      
      CompositeSerial.print("Sensor ");
      CompositeSerial.print(sensorId);
      CompositeSerial.print(": PRESS; ");
      CompositeSerial.print(rawValue);
      CompositeSerial.print("\n");
    }
    sensorLastDown[sensorId] = true;

  } else {
    if (sensorLastDown[sensorId] != false) {
      Keyboard.release(sensorKeycodes[sensorId]);

      CompositeSerial.print("Sensor ");
      CompositeSerial.print(sensorId);
      CompositeSerial.print(": RELEASE; ");
      CompositeSerial.print(rawValue);
      CompositeSerial.print("\n");
    }
    sensorLastDown[sensorId] = false;
  }
}

